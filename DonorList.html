<!-- OK -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor List</title>
  <link rel="stylesheet" href="./dist/output.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>

<body class="bg-red-600 text-white font-[Poppins] min-h-screen">

  <!-- Header -->
  <header class="bg-red-700 bg-opacity-90 p-6 text-center shadow-md">
    <h1 class="text-3xl font-bold">RUET Donor List</h1>
  </header>

  <!-- Search Bar -->
  <div class="p-6 max-w-5xl mx-auto flex justify-end mb-4">
    <input type="text" id="bloodSearch" placeholder="Search Blood Group..."
      class="px-4 py-2 rounded-md text-black w-60 focus:outline-none focus:ring-2 focus:ring-white" />
  </div>

  <!-- Donor Table -->
  <div class="p-6 max-w-5xl mx-auto">
    <table class="w-full table-auto border-collapse border border-red-400">
      <thead>
        <tr class="bg-red-800">
          <th class="border border-red-400 px-4 py-2 text-left">Name</th>
          <th class="border border-red-400 px-4 py-2 text-left">Blood Group</th>
          <th class="border border-red-400 px-4 py-2 text-left">Contact Number</th>
          <th class="border border-red-400 px-4 py-2 text-left">Last Donation (Days Ago)</th>
        </tr>
      </thead>
      <tbody id="donorTableBody">
      </tbody>
    </table>
  </div>

  <script>
    // Calculate difference in days
    function calculateDaysDiff(dateStr) {
      if (!dateStr) return "â€”"; // no donation date
      const today = new Date(); //present date
      const donationDate = new Date(dateStr);
      if (isNaN(donationDate)) return "Invalid Date";

      const diffTime = today - donationDate; //milisecond
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays + " days";
    }

    let allDonors = []; // array for all donors

    async function loadDonors() {
      try {
        const res = await fetch('/donorlist');
        if (!res.ok) throw new Error("Failed to fetch donors");

        allDonors = await res.json();
        renderDonors(allDonors);
      } catch (err) {
        console.error(err);
        alert("Failed to load donor list");
      }
    }

    function renderDonors(donors) { //show the donors
      const tbody = document.getElementById('donorTableBody');
      tbody.innerHTML = ''; // clear previous rows

      donors.forEach(donor => {
        const row = document.createElement('tr');
        row.classList.add('hover:bg-red-700', 'transition');

        const daysDiff = calculateDaysDiff(donor.lastDonation);

        row.innerHTML = `
          <td class="border border-red-400 px-4 py-2">${donor.username || ''}</td>
          <td class="border border-red-400 px-4 py-2">${donor.blood || ''}</td>
          <td class="border border-red-400 px-4 py-2">${donor.mobile || ''}</td>
          <td class="border border-red-400 px-4 py-2">${daysDiff}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Filter donors by blood group
    document.getElementById('bloodSearch').addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      const filtered = allDonors.filter(d => (d.blood || '').toLowerCase().includes(query));
      renderDonors(filtered);
    });
    
    loadDonors();
  </script>

</body>
</html>
